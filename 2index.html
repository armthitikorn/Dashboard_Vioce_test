<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</title>
  <style>
    body { font-family: Tahoma, sans-serif; padding: 20px; }
    .question { margin-bottom: 20px; }
    button { margin: 3px; }
    a { margin-left: 10px; }
    audio { display: block; margin-top: 5px; }
  </style>
</head>
<body>
  <h2>üé§ ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (20 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°)</h2>
  <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: <input type="text" id="username" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"></label>

  <div id="questions"></div>

  <script>
    // ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ recorder ‡πÅ‡∏•‡∏∞ chunks
    let recorders = {};
    let audioChunksList = {};

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 20 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
    const questionContainer = document.getElementById("questions");
    for (let i = 1; i <= 20; i++) {
      questionContainer.innerHTML += `
        <div class="question">
          <label>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${i}</label><br/>
          <button onclick="startRecording(${i})">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
          <button onclick="stopRecording(${i})">‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
          <a id="downloadLink${i}" style="display:none;"></a>
          <audio id="audioPlayer${i}" controls style="display:none;"></audio>
        </div>
      `;
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    window.startRecording = async function(index) {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const recorder = new MediaRecorder(stream);
      recorders[index] = recorder;
      audioChunksList[index] = [];

      recorder.ondataavailable = e => audioChunksList[index].push(e.data);
      recorder.start();
      alert(`üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${index} ‡πÅ‡∏•‡πâ‡∏ß`);
    };

    // ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    window.stopRecording = function(index) {
      const recorder = recorders[index], audioChunks = audioChunksList[index];
      if (!recorder) return;
      recorder.stop();

      recorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const username = document.getElementById("username").value || "anonymous";
        const audioFileName = `${username}_answer_${index}.webm`;

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        const audioUrl = URL.createObjectURL(audioBlob);
        const downloadLink = document.getElementById('downloadLink' + index);
        downloadLink.href = audioUrl;
        downloadLink.download = audioFileName;
        downloadLink.textContent = `üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ${index}`;
        downloadLink.style.display = 'inline-block';

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Player ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        const audioPlayer = document.getElementById('audioPlayer' + index);
        audioPlayer.src = audioUrl;
        audioPlayer.style.display = 'block';
      };
    };
  </script>
</body>
</html>
